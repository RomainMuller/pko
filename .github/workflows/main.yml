name: Validation Build

on:
  pull_request:
    branches: [master]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [8.x, 10.x, 12.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Set up Node
        uses: actions/setup-node@master
        with:
          version: ${{matrix.node-version}}
      - name: Set up CodeClimate
        if: matrix.node-version == '8.x'
        run: |
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 -o /tmp/cc-test-reporter
          chmod +x /tmp/cc-test-reporter
          /tmp/cc-test-reporter before-build
        env:
          CC_TEST_REPORTER_ID:  ${{secrets.CC_TEST_REPORTER_ID}}
          GIT_COMMIT_SHA:       ${GITHUB_SHA}
          GIT_BRANCH:           ${GITHUB_REF}
      - name: Install Dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Test
        run: |
          npm test
      - name: CodeClimate Report
        if: always() && matrix.node-version == '8.x'
        run: |
          if [ -f coverage/lcov.info ]; then
            /tmp/cc-test-reporter format-coverage --input-type lcov --output coverage/codeclimate.bin coverage/lcov.info
            /tmp/cc-test-reporter upload-coverage --input coverage/codeclimate.bin
          fi
          if [ ${{job.status}} = 'success' ]; then
            /tmp/cc-test-reporter after-build --exit-code 0
          else
            /tmp/cc-test-reporter after-build --exit-code 255
          fi
        env:
          CC_TEST_REPORTER_ID:  ${{secrets.CC_TEST_REPORTER_ID}}
          GIT_COMMIT_SHA:       ${GITHUB_SHA}
          GIT_BRANCH:           ${GITHUB_REF}
